name: Build and Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/')
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          python3 - <<'PY'
          import os
          import re
          import pathlib
          import sys

          version = os.environ.get("VERSION", "").strip()
          if not version:
              print("VERSION is empty", file=sys.stderr)
              sys.exit(1)

          path = pathlib.Path("AudioPriority.xcodeproj/project.pbxproj")
          text = path.read_text()
          new_text = re.sub(r"MARKETING_VERSION = [^;]+;", f"MARKETING_VERSION = {version};", text)
          if text == new_text:
              print(f"MARKETING_VERSION already {version}")
          else:
              path.write_text(new_text)
              print(f"Set MARKETING_VERSION to {version}")
          PY

      - name: Update changelog version
        if: startsWith(github.ref, 'refs/tags/')
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          RELEASE_DATE="$(date -u +%Y-%m-%d)"
          export VERSION RELEASE_DATE
          python3 - <<'PY'
          import os
          import pathlib
          import re
          import sys

          version = os.environ.get("VERSION", "").strip()
          release_date = os.environ.get("RELEASE_DATE", "").strip()
          if not version:
              print("VERSION is empty", file=sys.stderr)
              sys.exit(1)
          if not release_date:
              print("RELEASE_DATE is empty", file=sys.stderr)
              sys.exit(1)

          path = pathlib.Path("CHANGELOG.md")
          text = path.read_text()
          header_match = re.search(r"^## \\[Unreleased\\]\\n", text, re.M)
          if not header_match:
              print("Unreleased section not found", file=sys.stderr)
              sys.exit(1)

          start = header_match.end()
          next_header = re.search(r"^## \\[", text[start:], re.M)
          if next_header:
              body = text[start:start + next_header.start()]
              rest = text[start + next_header.start():]
          else:
              body = text[start:]
              rest = ""

          body = body.strip()

          def extract_section(section_name: str) -> str:
              pattern = rf"^###\\s+{re.escape(section_name)}\\s*$"
              match = re.search(pattern, body, re.M)
              if not match:
                  return ""
              section_start = match.end()
              next_match = re.search(r"^###\\s+", body[section_start:], re.M)
              if next_match:
                  content = body[section_start:section_start + next_match.start()]
              else:
                  content = body[section_start:]
              return content.strip()

          sections = {}
          for name in ("Added", "Changed", "Fixed", "Removed"):
              sections[name] = extract_section(name)

          release_section = f"## [{version}] - {release_date}\\n"
          for name in ("Added", "Changed", "Fixed", "Removed"):
              release_section += f"### {name}\\n"
              content = sections[name]
              if content:
                  release_section += f"{content}\\n"
              release_section += "\\n"

          new_text = text[:header_match.start()]
          new_text += "## [Unreleased]\\n"
          new_text += "### Added\\n\\n"
          new_text += "### Changed\\n\\n"
          new_text += "### Fixed\\n\\n"
          new_text += "### Removed\\n\\n"
          new_text += release_section + "\\n"
          new_text += rest.lstrip("\\n")
          path.write_text(new_text)
          print(f"Updated CHANGELOG.md for {version} ({release_date})")
          PY

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build
        run: |
          xcodebuild -scheme AudioPriority \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 -arch x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Test
        run: |
          xcodebuild -scheme AudioPriorityTests test

      - name: Package CLI
        run: |
          mkdir -p release
          mkdir -p release/Frameworks
          cp build/Build/Products/Release/audio-priority release/
          cp -R build/Build/Products/Release/AudioPriorityCore.framework release/Frameworks/
          cd release
          zip -r audio-priority.zip audio-priority Frameworks

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-priority
          path: release/audio-priority.zip

  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: audio-priority
          path: release

      - name: Create Tagged Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: release/audio-priority.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
